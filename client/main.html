<head>
  <meta charset=”UTF-8” />
  <title>Ed's Chat App :)</title>

  <script>
    document.documentElement.lang = "en-US";
    $("html").attr("xmlns", "http://www.w3.org/1999/xhtml");

    function chatInit() {
      if (typeof Chat === "undefined") {
        window.Chat = {};
      }

      Chat.messageListLengthLast = 0;
      Chat.messageHeightCalculated = 0;
      Chat.messageListHeightLastChange = 0;

      /*
      function setWidthView() {
        var w = getWindowWidth();
        document.getElementById("width").innerHTML = "width: " + w;
      }

      function setHeightView() {
        var h = getWindowHeight();
        document.getElementById("height").innerHTML = "height: " + h;
      }
      */

      function getWindowWidth() {
        return window.innerWidth
          || document.documentElement.clientWidth
          || document.body.clientWidth;
      }

      function getWindowHeight() {
        return window.innerHeight
          || document.documentElement.clientHeight
          || document.body.clientHeight;
      }

      function repositionTextInput() {
        var h = getWindowHeight() - 41;
        document.getElementById("text").style.top = h + "px";
      }

      function setListDimensions() {
        var w = getWindowWidth() - 16 - 158 - 8;
        var h = getWindowHeight() - 49 - 4;
        var list = document.getElementById("message-list");
        list.style.width = w + "px";
        list.style.height = h + "px";
      }

      function showModal() {
        document.getElementById("modal-wrapper").className = "overlay";
        var modalWindow = document.getElementById("modal-window");
        modalWindow.style.marginTop = (-modalWindow.offsetHeight)/2 + "px";
        modalWindow.style.marginLeft = (-modalWindow.offsetWidth)/2 + "px";
      }

      function closeModal(e) {
        e.preventDefault();

        if (document.getElementById("alias").value.length > 0) {
          var alias = document.getElementById("alias").value;
          var placeholder = "Alias: " + alias;
          document.getElementById("text").placeholder = placeholder;
          document.getElementById("sender").value = alias;
          document.getElementById("modal-wrapper").className = "";
          document.getElementById("text").focus();
        }
      }
      /*
      function addMessage(e) {
        e.preventDefault();
        if (e.target[0].value == "") return;

        var message = "<span class=\"mag-txt\">" + e.target[1].value + ": </span><span class=\"blue-txt\">" + e.target[0].value + "</span><span class=\"green-txt\"> -" + new Date() + "</span><br>";
        var list = document.getElementById("message-list");
        list.innerHTML = list.innerHTML + message;
        list.scrollTop = list.scrollHeight;
        document.getElementById("text").value = "";
      }
      */
      function keyHandler(e) {
        var modalWrapper = document.getElementById("modal-wrapper");
        if (modalWrapper.className === "overlay") {
          if(e.keyCode == 13) {
            closeModal(e);
            //document.forms["modal-form"].submit();
          }
        }
      }

      function leaveModalFormAlone(e) { e.stopPropagation(); }

      function scrollDownList() {
        var list = document.getElementById("message-list");

        if (list.scrollHeight > (parseInt(list.style.height) + 4)) {
          //console.log(list.scrollTop);
          //console.log(list.style.height);
          //console.log(list.scrollHeight);
          if (Chat.messageListLengthLast != list.innerHTML.length) {

            if (Chat.messageHeightCalculated <= 0) {
              //console.log("A");
              list.scrollTop = list.scrollHeight;
              Chat.messageHeightCalculated = list.scrollHeight;
              Chat.messageListHeightLastChange = Chat.messageHeightCalculated;

            } else if (Chat.messageListHeightLastChange === list.scrollHeight) {
              //console.log("B");

            } else if (Chat.messageHeightCalculated >
                Math.abs(list.scrollHeight-Chat.messageListHeightLastChange)) {
              //console.log("C");
              Chat.messageHeightCalculated =
                Math.abs(list.scrollHeight - Chat.messageListHeightLastChange);
              Chat.messageListHeightLastChange = list.scrollHeight;

            } else {
              //console.log("D");
              Chat.messageListHeightLastChange = list.scrollHeight;
            }

            //console.log(list.scrollHeight);
            //console.log(Chat.messageListHeightLastChange);
            var modalWrapper = document.getElementById("modal-wrapper");
            if (modalWrapper.className === "overlay") {
              list.scrollTop = list.scrollHeight;

            } else if ((list.scrollHeight - list.scrollTop) <
                (parseInt(list.style.height) +
                (Chat.messageHeightCalculated * 2))) {
              list.scrollTop = list.scrollHeight;
            }

            Chat.messageListLengthLast = list.innerHTML.length;
          }
        }
      }
      /*
      function analyze (e) {
        //console.log(e);
        var list = document.getElementById("message-list");
        console.log(list.scrollTop);
      }
      */
      if(document.addEventListener) {
        document.getElementById("modal-form").addEventListener("submit", closeModal, false);
        //document.getElementById("message-list").addEventListener("focus", analyze, false);
        //document.getElementById("message-form").addEventListener("submit", addMessage, false);
        document.addEventListener("keydown", keyHandler, false);
        document.getElementById("modal-form").addEventListener("keydown", leaveModalFormAlone, false);
      } else {
        document.getElementById("modal-form").attachEvent("onsubmit", closeModal);
        //document.getElementById("message-list").attachEvent("onfocus", analyze);
        //document.getElementById("message-form").attachEvent("onsubmit", addMessage);
        document.attachEvent("onkeydown", keyHandler);
        document.getElementById("modal-form").attachEvent("onkeydown", leaveModalFormAlone);
      }

      //setWidthView();
      //setHeightView();
      repositionTextInput();
      setListDimensions();
      showModal();
      setInterval(scrollDownList, 100);

      window.onresize = function() {
        setListDimensions();
        repositionTextInput();
        var list = document.getElementById("message-list");
        Chat.messageListHeightLastChange = list.scrollHeight;

        //setWidthView();
        //setHeightView();
      };
    }
  </script>

  <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js" />
  <![endif]-->
</head>

<body>
  <div id="container">

    <div id="message-list">
      {{> messagesList}}
    </div>

    {{> messageSubmit}}

  </div>

  <div id="modal-wrapper">
    <div id="modal-window">
      <form id="modal-form">

        <label for="alias">Your Alias:</label>
        <input type="text" autofocus required id="alias" name="alias"
          oninvalid="setCustomValidity('Please enter a Username')"
          onchange="try{setCustomValidity('')}catch(e){}" />

      </form>
    </div>
  </div>

  <script>
    document.onload = chatInit();
  </script>
</body>

